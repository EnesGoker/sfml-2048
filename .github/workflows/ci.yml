name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run format check
        run: ./scripts/check_format.sh

  static-analysis:
    name: Static Analysis (ubuntu-latest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.29.6

      - name: CMake version
        run: cmake --version

      - name: Install Linux build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            ccache \
            clang-tidy \
            libx11-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev \
            libxinerama-dev \
            libudev-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libflac-dev \
            libvorbis-dev \
            libopenal-dev \
            libfreetype6-dev

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-static-analysis-${{ hashFiles('CMakeLists.txt', 'CMakePresets.json', 'src/**/*.cpp', 'src/**/*.hpp', 'tests/**/*.cpp', 'tests/**/*.hpp') }}
          restore-keys: |
            ccache-static-analysis-

      - name: Restore vcpkg archives
        uses: actions/cache@v4
        with:
          path: ~/.cache/vcpkg/archives
          key: vcpkg-archives-static-analysis-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-archives-static-analysis-

      - name: Read vcpkg baseline
        run: |
          BASELINE="$(sed -n 's/.*"builtin-baseline":[[:space:]]*"\([^"]*\)".*/\1/p' vcpkg.json)"
          if [ -z "$BASELINE" ]; then
            echo "Failed to read builtin-baseline from vcpkg.json"
            exit 1
          fi
          echo "VCPKG_BASELINE=$BASELINE" >> "$GITHUB_ENV"

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$RUNNER_TEMP/vcpkg"
          git -C "$RUNNER_TEMP/vcpkg" checkout "$VCPKG_BASELINE"
          "$RUNNER_TEMP/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
          echo "VCPKG_ROOT=$RUNNER_TEMP/vcpkg" >> "$GITHUB_ENV"

      - name: Configure
        run: cmake --preset vcpkg-debug -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build compile database
        run: cmake --build --preset build-vcpkg-debug --target game_core core_unit_tests

      - name: Run clang-tidy (bugprone/performance/portability)
        run: |
          files="$(find src tests -type f -name '*.cpp' | sort)"
          if [ -z "$files" ]; then
            echo "No source files for clang-tidy"
            exit 0
          fi

          status=0
          while IFS= read -r file; do
            echo "clang-tidy: $file"
            if ! clang-tidy "$file" \
              -p build/vcpkg-debug \
              -checks='-*,bugprone-*,performance-*,portability-*'; then
              status=1
            fi
          done <<EOF
          $files
          EOF

          exit "$status"

      - name: ccache statistics
        run: ccache --show-stats

  build-and-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.29.6

      - name: CMake version
        run: cmake --version

      - name: Install Linux build tools
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            ccache \
            libx11-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev \
            libxinerama-dev \
            libudev-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libflac-dev \
            libvorbis-dev \
            libopenal-dev \
            libfreetype6-dev

      - name: Install macOS build tools
        if: runner.os == 'macOS'
        run: brew install ccache

      - name: Restore ccache (Linux/macOS)
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'CMakePresets.json', 'src/**/*.cpp', 'src/**/*.hpp', 'tests/**/*.cpp', 'tests/**/*.hpp') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Restore vcpkg archives (Linux/macOS)
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: ~/.cache/vcpkg/archives
          key: vcpkg-archives-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-archives-${{ runner.os }}-

      - name: Restore vcpkg archives (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: ${{ env.LOCALAPPDATA }}/vcpkg/archives
          key: vcpkg-archives-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-archives-${{ runner.os }}-

      - name: Read vcpkg baseline (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          BASELINE="$(sed -n 's/.*"builtin-baseline":[[:space:]]*"\([^"]*\)".*/\1/p' vcpkg.json)"
          if [ -z "$BASELINE" ]; then
            echo "Failed to read builtin-baseline from vcpkg.json"
            exit 1
          fi
          echo "VCPKG_BASELINE=$BASELINE" >> "$GITHUB_ENV"

      - name: Read vcpkg baseline (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $match = Select-String -Path "vcpkg.json" -Pattern '"builtin-baseline"\s*:\s*"([^"]+)"'
          if (-not $match) { throw "Failed to read builtin-baseline from vcpkg.json" }
          $baseline = $match.Matches[0].Groups[1].Value
          "VCPKG_BASELINE=$baseline" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup vcpkg (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$RUNNER_TEMP/vcpkg"
          git -C "$RUNNER_TEMP/vcpkg" checkout "$VCPKG_BASELINE"
          "$RUNNER_TEMP/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
          echo "VCPKG_ROOT=$RUNNER_TEMP/vcpkg" >> "$GITHUB_ENV"

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$env:RUNNER_TEMP/vcpkg"
          git -C "$env:RUNNER_TEMP/vcpkg" checkout "$env:VCPKG_BASELINE"
          & "$env:RUNNER_TEMP/vcpkg/bootstrap-vcpkg.bat" -disableMetrics
          "VCPKG_ROOT=$env:RUNNER_TEMP/vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        run: cmake --preset vcpkg-debug -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $toolchain = Join-Path $env:RUNNER_TEMP "vcpkg/scripts/buildsystems/vcpkg.cmake"
          if (-not (Test-Path $toolchain)) { throw "vcpkg toolchain file not found: $toolchain" }
          cmake `
            -S . `
            -B build/vcpkg-debug `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain"

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: cmake --build --preset build-vcpkg-debug

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build build/vcpkg-debug --config Debug

      - name: Test (Linux/macOS)
        if: runner.os != 'Windows'
        run: ctest --test-dir build/vcpkg-debug --output-on-failure

      - name: Test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ctest --test-dir build/vcpkg-debug --output-on-failure -C Debug

      - name: Windows runtime smoke (--help)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path ".\\build\\vcpkg-debug" -Filter "sfml_2048.exe" -Recurse | Select-Object -First 1
          if (-not $exe) { throw "sfml_2048.exe not found under build/vcpkg-debug" }
          & $exe.FullName --help

      - name: ccache statistics
        if: runner.os != 'Windows'
        run: ccache --show-stats

  sanitizers:
    name: Sanitizers (ubuntu-latest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.29.6

      - name: CMake version
        run: cmake --version

      - name: Install Linux build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            ccache \
            libx11-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev \
            libxinerama-dev \
            libudev-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libflac-dev \
            libvorbis-dev \
            libopenal-dev \
            libfreetype6-dev

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-sanitizers-${{ hashFiles('CMakeLists.txt', 'CMakePresets.json', 'src/**/*.cpp', 'src/**/*.hpp', 'tests/**/*.cpp', 'tests/**/*.hpp') }}
          restore-keys: |
            ccache-sanitizers-

      - name: Restore vcpkg archives
        uses: actions/cache@v4
        with:
          path: ~/.cache/vcpkg/archives
          key: vcpkg-archives-sanitizers-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-archives-sanitizers-

      - name: Read vcpkg baseline
        run: |
          BASELINE="$(sed -n 's/.*"builtin-baseline":[[:space:]]*"\([^"]*\)".*/\1/p' vcpkg.json)"
          if [ -z "$BASELINE" ]; then
            echo "Failed to read builtin-baseline from vcpkg.json"
            exit 1
          fi
          echo "VCPKG_BASELINE=$BASELINE" >> "$GITHUB_ENV"

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$RUNNER_TEMP/vcpkg"
          git -C "$RUNNER_TEMP/vcpkg" checkout "$VCPKG_BASELINE"
          "$RUNNER_TEMP/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
          echo "VCPKG_ROOT=$RUNNER_TEMP/vcpkg" >> "$GITHUB_ENV"

      - name: Configure (sanitizers)
        run: |
          cmake \
            -S . \
            -B build/sanitizers \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DSFML_2048_ENABLE_SANITIZERS=ON

      - name: Build (sanitizers)
        run: cmake --build build/sanitizers

      - name: Test (sanitizers)
        run: ctest --test-dir build/sanitizers --output-on-failure

      - name: ccache statistics
        run: ccache --show-stats

  coverage:
    name: Coverage (ubuntu-latest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.29.6

      - name: CMake version
        run: cmake --version

      - name: Install Linux build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            ccache \
            gcovr \
            libx11-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev \
            libxinerama-dev \
            libudev-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libflac-dev \
            libvorbis-dev \
            libopenal-dev \
            libfreetype6-dev

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-coverage-${{ hashFiles('CMakeLists.txt', 'CMakePresets.json', 'src/**/*.cpp', 'src/**/*.hpp', 'tests/**/*.cpp', 'tests/**/*.hpp') }}
          restore-keys: |
            ccache-coverage-

      - name: Restore vcpkg archives
        uses: actions/cache@v4
        with:
          path: ~/.cache/vcpkg/archives
          key: vcpkg-archives-coverage-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-archives-coverage-

      - name: Read vcpkg baseline
        run: |
          BASELINE="$(sed -n 's/.*"builtin-baseline":[[:space:]]*"\([^"]*\)".*/\1/p' vcpkg.json)"
          if [ -z "$BASELINE" ]; then
            echo "Failed to read builtin-baseline from vcpkg.json"
            exit 1
          fi
          echo "VCPKG_BASELINE=$BASELINE" >> "$GITHUB_ENV"

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$RUNNER_TEMP/vcpkg"
          git -C "$RUNNER_TEMP/vcpkg" checkout "$VCPKG_BASELINE"
          "$RUNNER_TEMP/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
          echo "VCPKG_ROOT=$RUNNER_TEMP/vcpkg" >> "$GITHUB_ENV"

      - name: Configure (coverage)
        run: |
          cmake \
            -S . \
            -B build/coverage \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DSFML_2048_ENABLE_COVERAGE=ON

      - name: Build (coverage)
        run: cmake --build build/coverage

      - name: Test (coverage)
        run: ctest --test-dir build/coverage --output-on-failure

      - name: Generate coverage report (>=80% line)
        run: |
          gcovr \
            --root . \
            --filter 'src/core' \
            --print-summary \
            --xml-pretty --xml build/coverage/coverage.xml \
            --html-details build/coverage/coverage.html \
            --fail-under-line 80

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            build/coverage/coverage.xml
            build/coverage/*.html
          if-no-files-found: error

      - name: ccache statistics
        run: ccache --show-stats
